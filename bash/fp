#!/bin/bash

target_tmp_dir="/tmp/tmp"
target_pkg_dir="$HOME/apps/pac/"

pkg_name="$1"

# Exit if no package name is given
if [[ -z "$pkg_name" ]]; then
  echo "meh"
  exit 1
fi

# Exit if target directory already exists
if [[ -d "$target_pkg_dir/$pkg_name" ]]; then
  echo "meeeeh"
  exit 1
fi

# Ensure we're not in the directory we might delete
cd ~

# Clean and prepare the temp dir
sudo rm -rf "$target_tmp_dir"
mkdir -p "$target_tmp_dir"
mkdir -p "$target_tmp_dir/$pkg_name"

# Download package
if ! sudo pacman --downloadonly --cachedir="$target_tmp_dir" -Sw "$pkg_name"; then
  echo "Failed to download package: $pkg_name"
  exit 1
fi

# Extract all downloaded packages
for f in "$target_tmp_dir"/*.pkg.tar.zst; do
  [[ -e "$f" ]] || continue  # skip if no matches
  echo "Extracting: $f"
  tar -xvf "$f" -C "$target_tmp_dir"
done

# Move bin and/or lib if they exist
if [[ -d "$target_tmp_dir/usr/bin" ]]; then
  mv "$target_tmp_dir/usr/bin" "$target_tmp_dir/$pkg_name/"
fi

if [[ -d "$target_tmp_dir/usr/lib" ]]; then
  mv "$target_tmp_dir/usr/lib" "$target_tmp_dir/$pkg_name/"
fi

mv "$target_tmp_dir/$pkg_name" "$target_pkg_dir"

echo "done"

